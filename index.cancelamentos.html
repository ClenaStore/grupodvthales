<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>Cancelamentos - Grupo DV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0b1020; --surface:#10172a; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
      --line:rgba(148,163,184,.25); --icon-bg:rgba(255,255,255,.06);
      --shadow:0 20px 60px rgba(2,6,23,.35); --brand:#60a5fa; --brand2:#22d3ee;
      --ok:#16a34a; --bad:#dc2626;
    }
    [data-theme="light"]{
      --bg:#f6f7fb; --surface:#fff; --card:#fff; --text:#0f172a; --muted:#475569;
      --line:#e5e7eb; --icon-bg:rgba(2,6,23,.06); --shadow:0 16px 36px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text);}
    header{position:sticky; top:0; z-index:40; backdrop-filter:saturate(160%) blur(8px);
      background:color-mix(in srgb, var(--surface) 80%, transparent); border-bottom:1px solid var(--line);}
    .head{max-width:1200px; margin:0 auto; padding:14px 18px; display:flex; align-items:center; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit}
    .brand img{height:42px}
    .title{font-weight:800; font-size:clamp(18px,1.6vw,22px)}
    .grow{flex:1}
    .btn{border:1px solid var(--line); background:var(--surface); color:var(--text);
      padding:10px 12px; border-radius:12px; font-weight:800; cursor:pointer; display:inline-flex; gap:8px; align-items:center}
    .btn:hover{box-shadow:var(--shadow); transform:translateY(-1px)}
    .only-desktop{display:inline-flex}
    @media (max-width:900px){.only-desktop{display:none!important}}
    .container{max-width:1200px; margin:0 auto; padding:20px 18px}
    .filters{display:grid; grid-template-columns:220px 220px 220px 1fr 200px; gap:12px; align-items:end}
    @media (max-width:1100px){.filters{grid-template-columns:1fr 1fr}}
    @media (max-width:600px){.filters{grid-template-columns:1fr}}
    .field label{display:block; margin:0 0 6px; color:var(--muted); font-weight:800; font-size:.95rem}
    select,input[type="date"],input[type="text"]{width:100%; border:1px solid var(--line); background:var(--surface);
      color:var(--text); border-radius:12px; padding:12px 14px; font-weight:700;}
    .action{width:100%}
    .grupo-empresa{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:var(--shadow); margin-bottom:16px;}
    .grupo-empresa h2{margin:0 0 10px; font-size:1.02rem; color:var(--text)}
    .item-cancelamento{border-top:1px dashed var(--line); padding:10px 0}
    .item-cancelamento:first-child{border-top:none}
    .item-cancelamento p{margin:4px 0; color:var(--muted)}
    .total-cancelado{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:var(--shadow); font-weight:800; margin-top:8px; margin-bottom:16px;}
    .dados-analisados{text-align:center; color:var(--muted); font-size:.95em; margin-top:12px}
    .chart-box{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:16px; margin:16px 0}
    #graficoCancelamentos{width:100%!important; height:320px!important}
  </style>
</head>
<body>
  <header>
    <div class="head">
      <a class="brand" href="#"><img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true" alt="Logo">
        <span class="title">Cancelamentos</span></a>
      <div class="grow"></div>
      <a class="btn only-desktop" href="#">üìÑ Relat√≥rios</a>
      <button id="themeToggle" class="btn">üåì Tema</button>
    </div>
  </header>

  <div class="container">
    <div class="filters">
      <div class="field"><label>Data inicial</label><input type="date" id="dataInicio"></div>
      <div class="field"><label>Data final</label><input type="date" id="dataFim"></div>
      <div class="field"><label>Empresa</label>
        <select id="filtroEmpresa" disabled><option value="VILLA GOURMET" selected>VILLA GOURMET</option></select>
      </div>
      <div class="field"><label>Busca</label><input type="text" id="filtroBusca" placeholder="Buscar item..."></div>
      <div class="field"><label>&nbsp;</label><button id="btnFiltrar" class="btn action">üì§ WhatsApp</button></div>
    </div>

    <div class="total-cancelado">üìä Total Cancelado: <span id="totalCancelado"><strong>R$ 0,00</strong></span></div>
    <div id="infoPeriodo" class="dados-analisados"></div>

    <!-- Gr√°fico -->
    <div id="graficoContainer" class="chart-box">
      <h3 style="margin:0 0 8px">üìà Evolu√ß√£o dos Cancelamentos</h3>
      <canvas id="graficoCancelamentos"></canvas>
    </div>

    <div id="listaCancelamentos"></div>
    <div class="dados-analisados" id="resumoDados"></div>
  </div>

<script>
const URL_SCRIPT = '/api/cancelamentos';
let cancelamentos = [];
let chartCancelamentos = null;
const $$ = s => document.querySelector(s);
const BRL = v => (Number(v)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const fmtDataBR = iso => { if(!iso) return ''; const [y,m,d]=iso.split('-'); return `${d}/${m}/${y}`; };

function preencherDataPadrao(){
  const hoje = new Date(); const inicio = new Date(hoje.getFullYear(),hoje.getMonth(),1);
  const iso = d => new Date(d.getFullYear(),d.getMonth(),d.getDate()).toISOString().split('T')[0];
  $$('#dataInicio').value = iso(inicio); $$('#dataFim').value = iso(hoje);
}

async function carregarDados(){
  try{
    const res = await fetch(URL_SCRIPT);
    cancelamentos = await res.json();
    aplicarFiltros();
  }catch(e){ console.error(e); }
}

function aplicarFiltros(){
  const emp = "VILLA GOURMET";
  const busca = ($$('#filtroBusca').value||'').toLowerCase();
  const di = $$('#dataInicio').value; const df = $$('#dataFim').value;
  const grupos = {}; let totalGeral = 0;

  cancelamentos.forEach(c=>{
    if(c.empresa !== emp) return;
    if(busca && !String(c.item).toLowerCase().includes(busca)) return;
    if(di && c.data < di) return;
    if(df && c.data > df) return;
    (grupos[c.empresa]||(grupos[c.empresa]=[])).push(c);
  });

  const lista = $$('#listaCancelamentos'); lista.innerHTML='';
  Object.keys(grupos).forEach(empresa=>{
    const grupo = grupos[empresa].sort((a,b)=> a.data.localeCompare(b.data));
    let subtotal = grupo.reduce((s,c)=>s+(+c.valor||0),0); totalGeral += subtotal;
    const card = document.createElement('div'); card.className='grupo-empresa';
    card.innerHTML = `<h2>üìÖ ${fmtDataBR(grupo[0]?.data)} ‚Ä¢ üè¢ ${empresa} ‚Äî <strong>Subtotal: ${BRL(subtotal)}</strong></h2>`;
    grupo.forEach(c=>{
      card.innerHTML += `<div class="item-cancelamento"><p>${c.item||'-'}</p><p>üí∏ ${BRL(c.valor||0)}</p></div>`;
    });
    lista.appendChild(card);
    desenharGrafico(grupo);
  });
  $$('#totalCancelado').innerHTML = `<strong>${BRL(totalGeral)}</strong>`;
  $$('#infoPeriodo').textContent = `Dados analisados ‚Ä¢ ${fmtDataBR(di)} ‚Üí ${fmtDataBR(df)}`;
}

function desenharGrafico(lista){
  const porData={}; lista.forEach(c=>{ porData[c.data]=(porData[c.data]||0)+(+c.valor||0); });
  const labels=Object.keys(porData).sort(); const valores=labels.map(d=>porData[d]);
  const ctx=$$('#graficoCancelamentos').getContext('2d');
  if(chartCancelamentos) chartCancelamentos.destroy();
  chartCancelamentos=new Chart(ctx,{type:'line',
    data:{labels:labels.map(fmtDataBR),datasets:[{label:'Cancelamentos por Dia',data:valores,
      borderColor:'#e74c3c',backgroundColor:'rgba(231,76,60,.12)',tension:.25,fill:true}]},
    options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>BRL(c.parsed.y)}}},
      scales:{y:{beginAtZero:true,ticks:{callback:v=>BRL(v)}}}}
  });
}

document.getElementById('dataInicio').addEventListener('change', aplicarFiltros);
document.getElementById('dataFim').addEventListener('change', aplicarFiltros);
document.getElementById('filtroBusca').addEventListener('input', aplicarFiltros);

(function init(){preencherDataPadrao();carregarDados();})();
</script>
</body>
</html>
