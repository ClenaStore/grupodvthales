<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Cancelamentos - Grupo DV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#f6f7fb; --surface:#fff; --card:#fff; --text:#0f172a; --muted:#475569;
      --line:#e5e7eb; --icon-bg:rgba(2,6,23,.06); --shadow:0 16px 36px rgba(15,23,42,.08);
      --ok:#16a34a; --bad:#dc2626; --brand:#0ea5e9;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:ui-sans-serif,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text)}

    header{position:sticky; top:0; z-index:40; background:#fff; border-bottom:1px solid var(--line);}
    .head{max-width:1200px; margin:0 auto; padding:14px 18px; display:flex; align-items:center; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit}
    .brand img{height:38px}
    .title{font-weight:800; font-size:18px}
    .grow{flex:1}
    .btn{border:1px solid var(--line); background:var(--surface); color:var(--text);
      padding:8px 14px; border-radius:10px; font-weight:700; cursor:pointer}
    .btn-whats{ background:#25d366; color:#fff; border:none }
    .btn:hover{box-shadow:var(--shadow)}

    .container{max-width:1200px; margin:0 auto; padding:20px 18px}
    .filters{display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:12px; align-items:end}
    .field label{display:block; margin:0 0 6px; color:var(--muted); font-weight:700; font-size:.9rem}
    select, input[type="date"], input[type="text"]{
      width:100%; border:1px solid var(--line); background:var(--surface); color:var(--text);
      border-radius:10px; padding:10px 12px; font-weight:600;
    }

    .total-cancelado{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px; box-shadow:var(--shadow); font-weight:800; margin-top:16px}
    .dados-analisados{ text-align:center; color:var(--muted); font-size:.95em; margin-top:10px }

    .chart-box{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:16px; margin:18px 0; box-shadow:var(--shadow)}
    #graficoCancelamentos{width:100%!important; height:320px!important}

    .grupo-empresa{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px; box-shadow:var(--shadow); margin-bottom:14px;}
    .item-cancelamento{border-top:1px dashed var(--line); padding:10px 0}
    .item-cancelamento:first-child{border-top:none}
    .item-cancelamento p{margin:4px 0; color:var(--muted)}

    .loading{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:60}
    .loading.show{display:flex}
    .spinner{width:64px; height:64px; border-radius:50%; border:6px solid rgba(255,255,255,.25); border-top-color:#fff; animation:spin 1s linear infinite}
    .loading p{color:#fff; font-weight:700; margin-top:12px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <header>
    <div class="head">
      <a class="brand" href="index.html"><img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true"><span class="title">Cancelamentos</span></a>
      <div class="grow"></div>
      <a class="btn" href="index.relatorios.html">üìÑ Relat√≥rios</a>
    </div>
  </header>

  <div id="loading" class="loading"><div style="display:flex; flex-direction:column; align-items:center;"><div class="spinner"></div><p>Carregando dados...</p></div></div>

  <div class="container">
    <div class="filters">
      <div class="field"><label>Data inicial</label><input type="date" id="dataInicio" /></div>
      <div class="field"><label>Data final</label><input type="date" id="dataFim" /></div>
      <div class="field"><label>Empresa</label>
        <input type="text" value="VILLA GOURMET" readonly />
      </div>
      <div class="field"><label>Busca</label><input type="text" id="filtroBusca" placeholder="Buscar item..." /></div>
      <div class="field"><label>&nbsp;</label><button id="btnFiltrar" class="btn btn-whats">üì§ WhatsApp</button></div>
    </div>

    <div class="total-cancelado">üìä Total Cancelado: <span id="totalCancelado"><strong>R$ 0,00</strong></span></div>
    <div id="infoPeriodo" class="dados-analisados"></div>

    <div id="graficoContainer" class="chart-box">
      <h3 style="margin:0 0 8px">üìà Evolu√ß√£o dos Cancelamentos</h3>
      <canvas id="graficoCancelamentos"></canvas>
    </div>

    <div id="listaCancelamentos"></div>
    <div class="dados-analisados" id="resumoDados"></div>
  </div>

<script>
const URL_SCRIPT = '/api/cancelamentos'; // ajuste para sua API
let cancelamentos = [];
let chartCancelamentos = null;
const $$ = sel => document.querySelector(sel);
const showLoading = v => $$('#loading').classList.toggle('show', !!v);
const BRL = v => (Number(v)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const fmtDataBR = iso => { if(!iso) return ''; const [y,m,d]=iso.split('-'); return `${d}/${m}/${y}`; };

function preencherDataPadrao(){
  const hoje = new Date(); const inicio = new Date(hoje.getFullYear(),hoje.getMonth(),1);
  const iso = d => d.toISOString().split('T')[0];
  $$('#dataInicio').value = iso(inicio);
  $$('#dataFim').value    = iso(hoje);
}

async function carregarDados(){
  showLoading(true);
  try{
    const res = await fetch(URL_SCRIPT);
    cancelamentos = await res.json();
    aplicarFiltros();
  }catch(e){
    console.error(e);
    $$('#listaCancelamentos').innerHTML = `<p style="text-align:center; color:var(--muted)">Erro ao carregar dados.</p>`;
  }finally{ showLoading(false); }
}

function aplicarFiltros(){
  const emp = "VILLA GOURMET";
  const busca = ($$('#filtroBusca').value||'').toLowerCase();
  const di = $$('#dataInicio').value;
  const df = $$('#dataFim').value;

  const grupo = cancelamentos.filter(c=>{
    if(c.empresa !== emp) return false;
    if(busca && !String(c.item).toLowerCase().includes(busca)) return false;
    if(di && c.data < di) return false;
    if(df && c.data > df) return false;
    return true;
  }).sort((a,b)=> a.data.localeCompare(b.data));

  let subtotal = grupo.reduce((s,c)=>s+(+c.valor||0),0);

  const lista = $$('#listaCancelamentos'); lista.innerHTML = '';
  if(grupo.length){
    const card = document.createElement('div'); card.className='grupo-empresa';
    card.innerHTML = `<h2>üìÖ ${fmtDataBR(grupo[0].data)} ‚Ä¢ üè¢ ${emp} ‚Äî <strong>Subtotal: ${BRL(subtotal)}</strong></h2>`;
    grupo.forEach(c=>{
      card.innerHTML += `<div class="item-cancelamento"><p>${c.item||'-'}</p><p>üí∏ ${BRL(c.valor||0)}</p></div>`;
    });
    lista.appendChild(card);
    desenharGrafico(grupo);
  }

  $$('#totalCancelado').innerHTML = `<strong>${BRL(subtotal)}</strong>`;
  const periodoTxt = (di&&df) ? `${fmtDataBR(di)} ‚Üí ${fmtDataBR(df)}` : 'Per√≠odo n√£o informado';
  $$('#infoPeriodo').textContent = `Dados analisados ‚Ä¢ ${periodoTxt}`;
}

function desenharGrafico(lista){
  const porData = {};
  lista.forEach(c=>{ porData[c.data] = (porData[c.data]||0) + (Number(c.valor)||0); });
  const labels = Object.keys(porData).sort();
  const valores = labels.map(d=> porData[d]);

  const ctx = $$('#graficoCancelamentos').getContext('2d');
  if(chartCancelamentos) chartCancelamentos.destroy();

  chartCancelamentos = new Chart(ctx,{
    type:'line',
    data:{labels: labels.map(fmtDataBR), datasets:[{label:'Cancelamentos por Dia',data: valores,borderColor:'#e74c3c',backgroundColor:'rgba(231,76,60,.12)',tension:.25,pointRadius:4,fill:true}]},
    options:{responsive:true, plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>BRL(c.parsed.y)}}}, scales:{y:{beginAtZero:true,ticks:{callback:v=>BRL(v)}}}}
  });
}

['change','input'].forEach(evt=>{
  $$('#dataInicio').addEventListener(evt, aplicarFiltros);
  $$('#dataFim').addEventListener(evt, aplicarFiltros);
  $$('#filtroBusca').addEventListener(evt, aplicarFiltros);
});
$('#btnFiltrar')?.addEventListener('click', ()=>alert("Fun√ß√£o WhatsApp ainda n√£o configurada."));

(function init(){ preencherDataPadrao(); carregarDados(); })();
</script>
</body>
</html>
