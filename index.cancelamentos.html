<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>Cancelamentos - Grupo DV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <style>
    :root{
      --bg:#0b1020; --surface:#10172a; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
      --line:rgba(148,163,184,.25); --icon-bg:rgba(255,255,255,.06);
      --shadow:0 20px 60px rgba(2,6,23,.35);
      --brand:#60a5fa; --brand2:#22d3ee;
      --ok:#16a34a; --bad:#dc2626;
    }
    [data-theme="light"]{
      --bg:#f6f7fb; --surface:#fff; --card:#fff; --text:#0f172a; --muted:#475569;
      --line:#e5e7eb; --icon-bg:rgba(2,6,23,.06);
      --shadow:0 16px 36px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}

    header{position:sticky;top:0;z-index:40;backdrop-filter:saturate(160%) blur(8px);
      background:color-mix(in srgb,var(--surface) 80%,transparent);border-bottom:1px solid var(--line)}
    .head{max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit}
    .brand img{height:42px}
    .title{font-weight:800;letter-spacing:.2px;font-size:clamp(18px,1.6vw,22px)}
    .grow{flex:1}
    .btn{border:1px solid var(--line);background:var(--surface);color:var(--text);
      padding:10px 12px;border-radius:12px;font-weight:800;cursor:pointer;display:inline-flex;gap:8px;align-items:center}
    .btn:hover{box-shadow:var(--shadow);transform:translateY(-1px)}
    .only-desktop{display:inline-flex}
    @media(max-width:900px){.only-desktop{display:none!important}}

    .user{position:relative}
    .user-btn{display:flex;align-items:center;gap:10px;border:1px solid var(--line);
      background:var(--surface);padding:6px 8px;border-radius:999px;cursor:pointer}
    .user-btn img{width:34px;height:34px;border-radius:50%;object-fit:cover;background:var(--icon-bg)}
    .user-menu{position:absolute;right:0;top:110%;background:var(--surface);border:1px solid var(--line);
      border-radius:12px;min-width:200px;padding:6px;box-shadow:var(--shadow);display:none}
    .user.open .user-menu{display:block}
    .user-menu a,.user-menu button{display:flex;width:100%;padding:10px 12px;border-radius:10px;
      border:none;background:transparent;color:var(--text);text-align:left;cursor:pointer;font-weight:600}
    .user-menu a:hover,.user-menu button:hover{background:var(--icon-bg)}

    .container{max-width:1200px;margin:0 auto;padding:20px 18px}

    .filters{display:grid;grid-template-columns:220px 220px 220px 1fr 200px;gap:12px;align-items:end}
    @media(max-width:1100px){.filters{grid-template-columns:1fr 1fr}}
    @media(max-width:600px){.filters{grid-template-columns:1fr}}
    .field label{display:block;margin:0 0 6px;color:var(--muted);font-weight:800;font-size:.95rem}
    select,input[type="date"],input[type="text"]{
      width:100%;border:1px solid var(--line);background:var(--surface);color:var(--text);
      border-radius:12px;padding:12px 14px;font-weight:700
    }
    .action{width:100%}

    .grupo-empresa{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:var(--shadow);margin-bottom:16px}
    .grupo-empresa h2{margin:0 0 10px;font-size:1.02rem;color:var(--text)}
    .item-cancelamento{border-top:1px dashed var(--line);padding:10px 0}
    .item-cancelamento:first-child{border-top:none}
    .item-cancelamento p{margin:4px 0;color:var(--muted)}

    .total-cancelado{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:var(--shadow);font-weight:800;margin-top:8px;margin-bottom:16px}
    .dados-analisados{text-align:center;color:var(--muted);font-size:.95em;margin-top:12px}

    .loading{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:60}
    .loading.show{display:flex}
    .spinner{width:74px;height:74px;border-radius:50%;border:6px solid rgba(255,255,255,.25);
      border-top-color:#fff;animation:spin 1s linear infinite}
    .loading p{color:#fff;font-weight:800;margin-top:12px;text-shadow:0 2px 6px rgba(0,0,0,.3)}
    @keyframes spin{to{transform:rotate(360deg)}}

    .btn-whats{background:#25d366;color:#fff;border-color:#21b75a}

    #botaoChatFlutuante{position:fixed;bottom:20px;right:20px;width:46px;height:46px;
      background:linear-gradient(140deg,#0B2240,color-mix(in srgb,#0B2240 70%,#22d3ee));
      color:#fff;border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;
      cursor:pointer;z-index:55;box-shadow:0 10px 28px rgba(2,6,23,.35);font-weight:900;letter-spacing:.3px}
    #botaoChatFlutuante:hover{transform:translateY(-1px);box-shadow:0 14px 34px rgba(2,6,23,.45)}
  </style>

  <script>
    (function(){
      const KEY='dv_pwd';
      const t=localStorage.getItem('dv_theme');if(t)document.documentElement.setAttribute('data-theme',t);

      window.__toggleTheme=function(){
        const cur=document.documentElement.getAttribute('data-theme')||'light';
        const next=(cur==='light')?'dark':'light';
        document.documentElement.setAttribute('data-theme',next);
        localStorage.setItem('dv_theme',next);
      };

      async function ensurePwd(){
        let pwd=localStorage.getItem(KEY)||'';
        while(!pwd){
          pwd=prompt('Digite a senha de acesso:')||'';
          if(!pwd)continue;
          try{
            const r=await fetch('/api/ping',{headers:{'x-api-key':pwd}});
            if(r.ok){localStorage.setItem(KEY,pwd);break;}
            alert('Senha incorreta.');pwd='';
          }catch{localStorage.setItem(KEY,pwd);break;}
        }
      }

      const _f=window.fetch.bind(window);
      window.fetch=(input,init={})=>{
        const url=(typeof input==='string')?input:(input&&input.url)||'';
        const headers=new Headers(init.headers||((typeof input!=='string'&&input.headers)||{}));
        const pwd=localStorage.getItem(KEY)||'';
        if(url.startsWith('/api/')&&pwd)headers.set('x-api-key',pwd);
        return _f(input,Object.assign({},init,{headers}));
      };

      if(!localStorage.getItem(KEY))ensurePwd();
      window.handleLogout=()=>{localStorage.removeItem(KEY);location.reload();}
    })();
  </script>
</head>
<body>
  <header>
    <div class="head">
      <a class="brand" href="index.html"><img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true"><span class="title">Cancelamentos</span></a>
      <div class="grow"></div>
      <a class="btn only-desktop" href="index.relatorios.html">📄 Relatórios</a>
      <button id="themeToggle" class="btn">🌓 Tema</button>
      <div class="user" id="userMenu">
        <button class="user-btn" type="button">
          <img src="https://github.com/ClenaStore/grupodvthales/blob/main/paste/Imagem%20do%20WhatsApp%20de%202025-09-19%20%C3%A0(s)%2010.13.35_6590510e.jpg?raw=true">
          <strong style="font-size:13px">Thales</strong>
        </button>
        <div class="user-menu">
          <a href="perfil.html">👤 Meu Perfil</a>
          <button onclick="handleLogout()">🚪 Sair</button>
        </div>
      </div>
    </div>
  </header>

  <div id="loading" class="loading"><div><div class="spinner"></div><p>Carregando dados...</p></div></div>

  <div class="container">
    <div class="filters">
      <div class="field"><label>Data inicial</label><input type="date" id="dataInicio"/></div>
      <div class="field"><label>Data final</label><input type="date" id="dataFim"/></div>
      <div class="field">
        <label>Empresa</label>
        <select id="filtroEmpresa" disabled><option value="VILLA GOURMET" selected>VILLA GOURMET</option></select>
      </div>
      <div class="field"><label>Busca</label><input type="text" id="filtroBusca" placeholder="Buscar item..."/></div>
      <div class="field"><label>&nbsp;</label><button id="btnFiltrar" class="btn action btn-whats">📤 WhatsApp</button></div>
    </div>

    <div class="total-cancelado">📊 Total Cancelado: <span id="totalCancelado"><strong>R$ 0,00</strong></span></div>
    <div id="infoPeriodo" class="dados-analisados"></div>
    <div id="listaCancelamentos"></div>
    <div class="dados-analisados" id="resumoDados"></div>
  </div>

  <button id="botaoChatFlutuante" onclick="abrirAssistente()">DV</button>

  <script>
    const URL_SCRIPT='/api/cancelamentos';
    let cancelamentos=[];
    const $$=s=>document.querySelector(s);
    const showLoading=v=>$$('#loading').classList.toggle('show',!!v);
    const BRL=v=>(Number(v)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    const fmtDataBR=iso=>{if(!iso)return'';const[y,m,d]=iso.split('-');return`${d}/${m}/${y}`};

    function preencherDataPadrao(){
      const hoje=new Date();const ontem=new Date(hoje);ontem.setDate(hoje.getDate()-1);
      const iso=d=>new Date(d.getFullYear(),d.getMonth(),d.getDate()).toISOString().split('T')[0];
      $$('#dataInicio').value=iso(ontem);$$('#dataFim').value=iso(ontem);
    }

    async function carregarDados(){
      showLoading(true);
      try{const res=await fetch(URL_SCRIPT);cancelamentos=await res.json();aplicarFiltros();}
      catch(e){console.error(e);$$('#listaCancelamentos').innerHTML="<p style='text-align:center;color:var(--muted)'>Erro ao carregar dados.</p>";}
      finally{showLoading(false);}
    }

    function aplicarFiltros(){
      const emp="VILLA GOURMET";
      const busca=($$('#filtroBusca').value||'').toLowerCase();
      const di=$$('#dataInicio').value;const df=$$('#dataFim').value;
      const grupos={};let totalGeral=0;

      cancelamentos.forEach(c=>{
        if(c.empresa!==emp)return;
        if(busca&&!String(c.item).toLowerCase().includes(busca))return;
        if(di&&c.data<di)return;if(df&&c.data>df)return;
        (grupos[c.empresa]||(grupos[c.empresa]=[])).push(c);
      });

      const lista=$$('#listaCancelamentos');lista.innerHTML='';
      Object.keys(grupos).forEach(empresa=>{
        const grupo=grupos[empresa].sort((a,b)=>a.data.localeCompare(b.data));
        let subtotal=0;
        const card=document.createElement('div');card.className='grupo-empresa';
        grupo.forEach(c=>subtotal+=(Number(c.valor)||0));
        totalGeral+=subtotal;
        const titulo=document.createElement('h2');
        const primeiraData=grupo[0]?.data||'';
        titulo.innerHTML=`📅 ${fmtDataBR(primeiraData)} • 🏢 ${empresa} — <strong>Subtotal: ${BRL(subtotal)}</strong>`;
        card.appendChild(titulo);
        grupo.forEach(c=>{
          const div=document.createElement('div');div.className='item-cancelamento';
          const[nomeItem,valorInfo]=String(c.item||'').split(' – ');
          div.innerHTML=`<p>${nomeItem||c.item||'-'}</p><p>💸 ${valorInfo||BRL(c.valor||0)}</p>`;
          card.appendChild(div);
        });
        lista.appendChild(card);
      });
      $$('#totalCancelado').innerHTML=`<strong>${BRL(totalGeral)}</strong>`;
      const periodoTxt=(di&&df)?`${fmtDataBR(di)} → ${fmtDataBR(df)}`:'Período não informado';
      $$('#infoPeriodo').textContent=`Dados analisados • ${periodoTxt}`;
    }

    function enviarWhatsapp(){
      const di=$$('#dataInicio').value,df=$$('#dataFim').value;
      const periodo=(di&&df)?`${fmtDataBR(di)} - ${fmtDataBR(df)}`:'Período não informado';
      const blocos=document.querySelectorAll('.grupo-empresa');if(!blocos.length)return alert('Nenhum dado para enviar.');
      let msg=`📆 Resumo de cancelamentos ${periodo}\n\n`;
      blocos.forEach(b=>{
        const h2=b.querySelector('h2')?.innerText||'';
        const itens=[...b.querySelectorAll('.item-cancelamento')].map(div=>div.innerText.replace(/\n/g,' • ')).join('\n');
        msg+=`*${h2}*\n${itens}\n\n`;
      });
      const numero='5577999761436';
      window.open(`https://wa.me/${numero}?text=${encodeURIComponent(msg.trim())}`,'_blank');
    }

    $$('#dataInicio').addEventListener('change',aplicarFiltros);
    $$('#dataFim').addEventListener('change',aplicarFiltros);
    $$('#filtroBusca').addEventListener('input',aplicarFiltros);
    $$('#btnFiltrar').addEventListener('click',enviarWhatsapp);

    (function init(){preencherDataPadrao();carregarDados();})();
  </script>
</body>
</html>
