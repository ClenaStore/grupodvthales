<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>ABC de Vendas ‚Ä¢ Grupo DV</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#f6f8fb; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --line:#e5e7eb;
    --brand:#2563eb; --ok:#16a34a; --warn:#b45309; --danger:#ef4444;
    --radius:16px; --shadow:0 12px 28px rgba(2,6,23,.06);
  }
  *{box-sizing:border-box}
  html, body { height:100%; }
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;
    background:var(--bg); color:var(--text);
    overflow-x:hidden;
  }
  header{
    position:sticky; top:0; z-index:10;
    display:flex; align-items:center; gap:16px;
    padding:14px 20px; background:#fff; border-bottom:1px solid var(--line);
  }
  header img{ height:56px; max-width:100%; }
  header h1{ margin:0; font-size:clamp(1.05rem, 1.2vw + .8rem, 1.6rem); font-weight:700; }
  .page{ min-height:calc(100vh - 86px); width:100vw; }
  .container{ width:100%; padding:18px 20px 28px; margin:0 auto; }
  .grid{ display:grid; gap:16px }
  .filters{ grid-template-columns:repeat(6, minmax(0,1fr)); }
  .lists{ grid-template-columns:repeat(3, minmax(0,1fr)); }
  @media (max-width:1200px){
    .filters{ grid-template-columns:repeat(4, minmax(0,1fr)); }
    .lists{ grid-template-columns:repeat(2, minmax(0,1fr)); }
  }
  @media (max-width:768px){
    .filters{ grid-template-columns:1fr; }
    .lists{ grid-template-columns:1fr; }
    .container{ padding:14px 12px 22px; }
  }
  .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); }
  .card.pad{ padding:14px }
  label{ font-weight:600; font-size:.9rem; margin-bottom:6px; display:block }
  select,input[type="date"],input[type="text"]{
    width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; font-size:.95rem
  }
  .kpis{ display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:16px; margin-top:16px }
  @media (max-width:1200px){ .kpis{ grid-template-columns:repeat(2,minmax(0,1fr)); } }
  @media (max-width:768px){ .kpis{ grid-template-columns:1fr; } }
  .kpi{ padding:16px }
  .kpi h3{ margin:0 0 6px; font-size:.85rem; color:var(--muted); font-weight:600 }
  .kpi p{ margin:0; font-size:clamp(1.1rem, 1.2vw + .9rem, 1.6rem); font-weight:800; }
  .section-title{ margin:18px 4px 10px; font-size:.95rem; font-weight:700 }
  #wrapGraf{ padding:10px }
  #graficoVendas{ display:none; width:100% !important; max-width:1600px; margin:0 auto 10px; }
  .item{ padding:10px 12px; border:1px dashed var(--line); border-radius:12px; margin-bottom:10px; background:#fff; }
  .muted{ color:var(--muted) }
  .loader{ display:flex; align-items:center; justify-content:center; gap:10px; padding:22px; color:var(--muted) }
  .spinner{ width:18px; height:18px; border:3px solid var(--line); border-top-color:var(--brand); border-radius:50%; animation:spin .8s linear infinite }
  @keyframes spin{ to{ transform:rotate(360deg) } }
  .empty,.error{ padding:18px; margin:8px 0; border-radius:12px; border:1px solid var(--line); background:#fff }
  .error{ border-color:#fecaca; background:#fff1f2; color:#991b1b }
</style>
<script>
/* intercepta senha */
(function(){
  const KEY_NAME='dv_pwd';
  async function ensurePassword(){
    let pwd=localStorage.getItem(KEY_NAME)||'';
    while(!pwd){
      pwd=prompt('Digite a senha de acesso:')||'';
      if(!pwd) continue;
      try{ const r=await fetch('/api/ping',{headers:{'x-api-key':pwd}});
        if(r.ok){ localStorage.setItem(KEY_NAME,pwd); break; }
        else{ alert('Senha incorreta.'); pwd=''; }
      }catch(e){ localStorage.setItem(KEY_NAME,pwd); break; }
    }
  }
  const _fetch=window.fetch.bind(window);
  window.fetch=(input,init={})=>{
    let url=(typeof input==='string')?input:(input&&input.url)||'';
    init=init||{}; const headers=new Headers(init.headers||((typeof input!=='string'&&input.headers)||{}));
    const pwd=localStorage.getItem(KEY_NAME)||'';
    if(url.startsWith('/api/')){ if(pwd) headers.set('x-api-key',pwd); }
    return _fetch(input,Object.assign({},init,{headers}));
  };
  if(!localStorage.getItem(KEY_NAME)){ ensurePassword(); }
})();
</script>
</head>
<body>
<header>
  <img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true" alt="Grupo DV">
  <h1>ABC de Vendas ‚Ä¢ Grupo DV</h1>
</header>

<div class="page">
  <div class="container">
    <!-- Filtros -->
    <div class="grid filters">
      <div class="card pad">
        <label>üè¢ Empresa</label>
        <select id="filtroEmpresa">
          <option value="MERCATTO">MERCATTO (padr√£o)</option>
          <option value="PADARIA">PADARIA (carregando‚Ä¶)</option>
          <option value="DELICIA">DELICIA (carregando‚Ä¶)</option>
          <option value="VILLA GOURMET">VILLA GOURMET (carregando‚Ä¶)</option>
          <option value="M. KIDS">M. KIDS (carregando‚Ä¶)</option>
          <option value="">Todas (depois que carregar)</option>
        </select>
      </div>
      <div class="card pad"><label>üîç Busca</label><input id="filtroBusca" type="text" placeholder="Produto..." /></div>
      <div class="card pad"><label>üìÖ In√≠cio</label><input id="dataInicio" type="date" /></div>
      <div class="card pad"><label>üìÖ Fim</label><input id="dataFim" type="date" /></div>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="card kpi"><h3>Faturamento</h3><p id="kpiFat">R$ 0,00</p></div>
      <div class="card kpi"><h3>Lucro</h3><p id="kpiLuc">R$ 0,00</p></div>
      <div class="card kpi"><h3>Qtd. Registros</h3><p id="kpiQtd">0</p></div>
      <div class="card kpi"><h3>Ticket M√©dio</h3><p id="kpiTicket">R$ 0,00</p></div>
    </div>

    <!-- Gr√°fico -->
    <div class="card" id="wrapGraf"><canvas id="graficoVendas"></canvas></div>

    <!-- Listas -->
    <div class="section-title">An√°lises</div>
    <div class="grid lists">
      <div class="card pad"><h3 class="muted">‚≠ê Top Produtos</h3><div id="topVendidos"></div></div>
      <div class="card pad"><h3 class="muted">üí∞ Mais Lucrativos</h3><div id="maisLucro"></div></div>
      <div class="card pad"><h3 class="muted">üìâ Menos Lucrativos</h3><div id="menosLucro"></div></div>
    </div>

    <div class="section-title">Registros</div>
    <div class="card pad">
      <div id="statusBox" class="loader"><div class="spinner"></div> Carregando MERCATTO‚Ä¶</div>
      <div id="listaVendas" style="display:none"></div>
    </div>
  </div>
</div>

<script>
const URL_SCRIPT='/api/abc_vendas';
const EMPRESAS=['MERCATTO','PADARIA','DELICIA','VILLA GOURMET','M. KIDS'];
let CACHE={}, RAW=[], chartVendas=null;
const $$=sel=>document.querySelector(sel);
const BRL=n=>(n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const dBR=iso=>!iso?'':iso.split('-').reverse().join('/');

async function fetchEmpresa(empresa){
  const url=empresa?`${URL_SCRIPT}?empresa=${encodeURIComponent(empresa)}`:URL_SCRIPT;
  const res=await fetch(url); const txt=await res.text(); let json;
  try{json=JSON.parse(txt);}catch(e){throw new Error('Resposta inv√°lida:\n'+txt.slice(0,300));}
  const arr=Array.isArray(json)?json:(json.dados||[]); return arr.filter(x=>x&&x.empresa);
}
function marcarEmpresaPronta(empresa){
  const sel=$$('#filtroEmpresa'); [...sel.options].forEach(o=>{if(o.value===empresa)o.textContent=empresa;});
  if(Object.keys(CACHE).length>=2){ const optTodas=[...sel.options].find(o=>o.value===''); if(optTodas) optTodas.textContent='Todas'; }
}
function setDatasPorFaixa(arr){
  const datas=arr.map(d=>d.data).filter(Boolean).sort(); if(!datas.length) return;
  $$('#dataInicio').value=datas[0]; $$('#dataFim').value=datas[datas.length-1];
}
function aplicar(){
  const emp=$$('#filtroEmpresa').value, busca=($$('#filtroBusca').value||'').toLowerCase();
  const di=$$('#dataInicio').value, df=$$('#dataFim').value;
  const base=emp?(CACHE[emp]||[]):RAW;
  let F=base.filter(r=>{
    if(busca&&!String(r.produto||'').toLowerCase().includes(busca))return false;
    if(di&&r.data<di)return false; if(df&&r.data>df)return false; return true;
  });
  if(di&&df){
    const hoje=new Date(), mesAtual=hoje.getMonth(), anoAtual=hoje.getFullYear(); const ini=new Date(di);
    if(!(ini.getMonth()===mesAtual&&ini.getFullYear()===anoAtual)){
      const ultimos={}; F.forEach(r=>{if(!r.data)return; const [ano,mes]=r.data.split('-').map(Number);
        const chave=`${ano}-${String(mes).padStart(2,'0')}`; if(!ultimos[chave]||r.data>ultimos[chave])ultimos[chave]=r.data;});
      const finais=new Set(Object.values(ultimos)); F=F.filter(r=>finais.has(r.data));
    }
  }
  const fat=F.reduce((s,x)=>s+(x.faturamento||0),0), luc=F.reduce((s,x)=>s+(x.lucro||0),0), qtd=F.length, ticket=qtd?(fat/qtd):0;
  $$('#kpiFat').textContent=BRL(fat); $$('#kpiLuc').textContent=BRL(luc);
  $$('#kpiQtd').textContent=qtd.toLocaleString('pt-BR'); $$('#kpiTicket').textContent=BRL(ticket);
  desenharGrafico(F);
  const byProd={}; F.forEach(x=>{const p=x.produto||''; if(!byProd[p])byProd[p]={q:0,f:0,l:0};
    byProd[p].q+=(x.quantidade||0); byProd[p].f+=(x.faturamento||0); byProd[p].l+=(x.lucro||0);});
  const arr=Object.entries(byProd).map(([produto,v])=>({produto,...v}));
  renderLista('#topVendidos',[...arr].sort((a,b)=>b.f-a.f).slice(0,5),p=>`‚≠ê ${p.produto} ‚Äî ${p.q} un ‚Ä¢ ${BRL(p.f)}`);
  renderLista('#maisLucro',[...arr].sort((a,b)=>b.l-a.l).slice(0,5),p=>`üí∞ ${p.produto} ‚Äî ${BRL(p.l)}`);
  renderLista('#menosLucro',[...arr].sort((a,b)=>a.l-b.l).slice(0,5),p=>`üìâ ${p.produto} ‚Äî ${BRL(p.l)}`);
  const agrup={}, cont=$$('#listaVendas'); F.forEach(x=>{const k=`${x.produto}__${x.empresa}`;
    if(!agrup[k])agrup[k]={produto:x.produto,empresa:x.empresa,q:0,f:0,l:0};
    agrup[k].q+=(x.quantidade||0); agrup[k].f+=(x.faturamento||0); agrup[k].l+=(x.lucro||0);});
  const lista=Object.values(agrup).sort((a,b)=>b.f-a.f); cont.innerHTML='';
  lista.forEach(p=>{const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<strong>${p.produto}</strong> <span class="muted">‚Ä¢ ${p.empresa}</span><br>${p.q} un ‚Ä¢ ${BRL(p.f)} ‚Ä¢ Lucro: ${BRL(p.l)}`; cont.appendChild(div);});
  const box=$$('#statusBox'); if(!lista.length){box.style.display='block'; box.className='empty'; box.textContent='Nenhum registro.';}
  else{box.style.display='none'; $$('#listaVendas').style.display='block';}
}
function renderLista(sel,arr,fmt){const el=document.querySelector(sel);el.innerHTML=arr.map(x=>`<div class="item">${fmt(x)}</div>`).join('')||'<div class="muted">‚Äî</div>';}
function desenharGrafico(F){const canvas=$$('#graficoVendas'); const porDia={}; F.forEach(x=>porDia[x.data]=(porDia[x.data]||0)+(x.faturamento||0));
  const labels=Object.keys(porDia).sort(), vals=labels.map(d=>porDia[d]); if(chartVendas)chartVendas.destroy();
  chartVendas=new Chart(canvas.getContext('2d'),{type:'line',data:{labels:labels.map(dBR),datasets:[{label:'Faturamento por dia',data:vals,fill:true,borderColor:'#2563eb',backgroundColor:'rgba(37,99,235,.15)',pointRadius:4,pointHoverRadius:6}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}},plugins:{legend:{display:false},title:{display:true,text:'Evolu√ß√£o de Vendas'}}}});
  canvas.style.display='block';}

/* BOOTSTRAP com cache */
async function boot(){
  const box=$$('#statusBox'), LS_KEY='dv_cache', EXPIRA_MS=20*60*60*1000; let cache=null;
  try{const raw=localStorage.getItem(LS_KEY); if(raw){const parsed=JSON.parse(raw); if(Date.now()-parsed.ts<EXPIRA_MS)cache=parsed.data;}}catch(e){}
  if(cache){CACHE=cache; RAW=Object.values(CACHE).flat(); marcarEmpresaPronta('MERCATTO'); setDatasPorFaixa(RAW); aplicar(); box.style.display='none'; return;}
  try{box.innerHTML='<div class="spinner"></div> Carregando MERCATTO‚Ä¶'; const mercatto=await fetchEmpresa('MERCATTO');
    CACHE['MERCATTO']=mercatto; RAW=mercatto.slice(); setDatasPorFaixa(mercatto); marcarEmpresaPronta('MERCATTO'); $$('#filtroEmpresa').value='MERCATTO'; aplicar();}
  catch(e){box.className='error'; box.textContent='Erro ao carregar MERCATTO: '+(e.message||e); return;}
  const restantes=EMPRESAS.filter(e=>e!=='MERCATTO'); for(const emp of restantes){try{const arr=await fetchEmpresa(emp); CACHE[emp]=arr; RAW=Object.values(CACHE).flat(); marcarEmpresaPronta(emp); if($$('#filtroEmpresa').value===emp){setDatasPorFaixa(arr); aplicar();}}catch(e){const sel=$$('#filtroEmpresa');[...sel.options].forEach(o=>{if(o.value===emp)o.textContent=`${
${emp} (erro ao carregar)`;});}}
  try{localStorage.setItem(LS_KEY,JSON.stringify({data:CACHE,ts:Date.now()}));}catch(e){}
  if(Object.keys(CACHE).length>=2){const optTodas=[...$$('#filtroEmpresa').options].find(o=>o.value==='');if(optTodas)optTodas.textContent='Todas';}
  box.style.display='none';
}

window.addEventListener('load',()=>{
  boot();
  ['change','input'].forEach(evt=>{
    $$('#filtroEmpresa').addEventListener(evt,()=>{
      const emp=$$('#filtroEmpresa').value;
      if(emp&&CACHE[emp]&&CACHE[emp].length){setDatasPorFaixa(CACHE[emp]);}
      else if(!emp&&RAW.length){setDatasPorFaixa(RAW);}
      aplicar();
    });
    $$('#filtroBusca').addEventListener(evt,aplicar);
    $$('#dataInicio').addEventListener(evt,aplicar);
    $$('#dataFim').addEventListener(evt,aplicar);
  });
});
</script>
</body>
</html>
