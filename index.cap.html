
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Aprova√ß√£o de CAP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
<style>
:root{
  --bg:#0b1220;--card:#0f172a;--ink:#e5f0ff;--muted:#a8b3c7;--line:#243043;
  --teal:#06b6d4;--blue:#4f46e5;--green:#16a34a;--red:#ef4444;--amber:#f59e0b;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink);font-size:15px}

header {
  position:sticky;
  top:0;
  z-index:10000; /* ‚úÖ maior que os status cards */
  background:linear-gradient(180deg,#0f172a,#0b1220);
  border-bottom:1px solid var(--line);
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

       

header h1 {
  font-size: 20px;
  font-weight: 800;
  margin: 0 0 4px 0;
  text-align: center;
}

/* üîπ Linha de filtros */
.filtros-linha {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.filtros-linha select,
.filtros-linha input,
.filtros-linha button {
  flex: 1 1 25%;
  background: #0b1528;
  border: 1px solid #22314b;
  color: var(--ink);
  padding: 10px 14px;
  border-radius: 10px;
  font-size: 15px;
}

/* üîπ Linha dos valores de status ‚Äî em linha com rolagem horizontal */
.status-header {
  display: flex;
  flex-direction: row;
  gap: 10px;
  margin-top: 8px;
  overflow-x: auto;                /* ativa rolagem horizontal */
  overflow-y: hidden;
  scroll-behavior: smooth;
  padding-bottom: 6px;
  -webkit-overflow-scrolling: touch; /* rolagem suave no mobile */
}

/* üîπ Esconde barra de rolagem no mobile */
.status-header::-webkit-scrollbar {
  height: 6px;
}
.status-header::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 6px;
}
.status-header::-webkit-scrollbar-track {
  background: transparent;
}

/* üîπ Cada card menor e responsivo */
.status-item {
  flex: 0 0 160px;                /* largura fixa m√≠nima */
  text-align: center;
  border-radius: 12px;
  padding: 10px 8px;
  color: #fff;
  font-weight: 700;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  min-height: 70px;
}

/* üîπ Textos menores */
.status-item span {
  display: block;
  font-size: 13px;
  opacity: 0.9;
}
.status-item b {
  font-size: 16px;
  margin-top: 2px;
}

/* üîπ Cores dos cards */
.status-item.aprovado {
  background: linear-gradient(180deg, #19c37d, #16a34a);
}
.status-item.pendente {
  background: linear-gradient(180deg, #60a5fa, #1d4ed8);
}
.status-item.negado {
  background: linear-gradient(180deg, #fb6969, #ef4444);
}

/* üîπ No desktop: distribui igualmente sem rolagem */
@media (min-width: 768px) {
  .status-header {
    justify-content: space-between;
    overflow-x: hidden;
  }
  .status-item {
    flex: 1;
  }
}



select,input{background:#0b1528;border:1px solid #22314b;color:var(--ink);
  padding:10px 14px;border-radius:10px;font-size:15px;width:100%}
.btn{border:1px solid #2a3955;background:#0b1528;color:var(--ink);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;font-size:15px;width:100%;position:relative;overflow:hidden}
.btn.icon{display:flex;align-items:center;gap:6px;justify-content:center}

#overlay{position:fixed;inset:0;background:rgba(3,7,18,.55);display:none;align-items:center;justify-content:center;z-index:100}
.spinner{width:56px;height:56px;border:6px solid var(--teal);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.spinner-btn{width:16px;height:16px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;position:absolute;top:50%;left:50%;margin:-8px 0 0 -8px;display:none}
.loading .spinner-btn{display:block}
.loading span,.loading b,.loading i{visibility:hidden}

.container{padding:16px;max-width:1250px;margin:0 auto}

/* Status cards fixos abaixo do cabe√ßalho */
.status-cards {
  display: flex;
  gap: 12px;
  margin: 12px 0;

  position: sticky;
  top: 70px;                /* fica logo abaixo do header */
  z-index: 30;
  background: var(--bg);
  padding: 10px 0;
  overflow-x: auto;         /* üîπ ativa scroll lateral no mobile */
  -webkit-overflow-scrolling: touch;
}

/* Esconde barra de rolagem mas mant√©m o scroll */
.status-cards::-webkit-scrollbar {
  display: none;
}

/* Cada card */
.status-card {
  flex: 1 0 200px;           /* üîπ largura m√≠nima p/ caber no carrossel */
  border-radius: 12px;
  padding: 14px;
  font-weight: 700;
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: #fff;
  font-size: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,.25);
  min-width: 200px;          /* garante tamanho fixo no mobile */
}

/* Desktop: cards ocupam lado a lado e n√£o precisam scroll */
@media (min-width: 768px) {
  .status-cards {
    overflow-x: hidden;      /* tira o scroll no desktop */
  }
  .status-card {
    flex: 1;                 /* todos com mesma largura */
    min-width: auto;         /* libera para expandir */
  }
}



.status-card span { font-size: 14px; }
.status-card b { font-size: 18px; }

.status-card.aprovado { background: linear-gradient(180deg,#19c37d,#16a34a); }
.status-card.negado   { background: linear-gradient(180deg,#fb6969,#ef4444); }
.status-card.pendente { background: linear-gradient(180deg,#60a5fa,#1d4ed8); }

/* üîπ Oculta scrollbar no desktop, mas permite arrastar no mobile */
.status-cards::-webkit-scrollbar {
  height: 6px;
}
.status-cards::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,.2);
  border-radius: 4px;
}

.mods-card{margin:16px 0;background:#0f172a;border:1px solid var(--line);border-radius:18px;padding:16px}
.mods {
  display: grid;
  grid-template-columns: 1fr 1fr; /* üîπ Agora 2 cards por linha por padr√£o */
  gap: 12px;
}

@media(min-width:768px){
  .mods { grid-template-columns: 1fr 1fr; } /* mant√©m 2 no tablet */
}

@media(min-width:1024px){
  .mods { grid-template-columns: 1fr 1fr 1fr; } /* 3 no desktop */
}

.mod{border-radius:16px;padding:14px;font-weight:700;display:flex;justify-content:space-between;align-items:center;color:#fff;font-size:16px}
.mod.total{background:#0f172a;border:1px solid var(--line)}
.mod.pix {
  background: linear-gradient(180deg, #3b82f6, #1e40af);   /* Azul */
}

.mod.cartao {
  background: linear-gradient(180deg, #22c55e, #15803d);   /* Verde */
}

.mod.boleto {
  background: linear-gradient(180deg, #9ca3af, #374151);   /* Cinza */
}


.list-head{display:flex;align-items:center;justify-content:space-between;margin-top:10px;font-size:16px}
.lista{display:grid;gap:14px;margin-top:14px}
.titulo{background:linear-gradient(180deg,#101a2f,#0f172a);border:1px solid var(--line);
  border-radius:18px;padding:12px;display:grid;grid-template-columns:1fr;gap:10px;position:relative}
.ck input{width:22px;height:22px}
.row{display:flex;gap:10px;flex-wrap:wrap;font-size:14px;color:var(--muted)}
.row b{color:var(--ink);font-size:15px}
.row.hist{color:#f59e0b;font-weight:600;font-size:13px}

.pill{padding:6px 12px;border-radius:999px;border:1px solid #2a3955;background:#0b1528;font-size:13px;font-weight:800;
  position:absolute;top:8px;right:8px}
.pill.ok{border-color:#155e32;color:#b6f3c5;background:#0e2a1b}
.pill.warn{border-color:#7a1e1e;color:#ffb4b4;background:#2a0e0e}

.actions{display:flex;gap:6px;flex-wrap:wrap}
.mini{flex:1 1 calc(50% - 6px);padding:8px;border-radius:12px;border:1px solid #22314b;background:#0b1528;color:#fff;font-weight:700;cursor:pointer;font-size:14px;text-align:center;position:relative;overflow:hidden}
.mini.aprovar{background:linear-gradient(180deg,#19c37d,#16a34a)}
.mini.negar{background:linear-gradient(180deg,#fb6969,#ef4444)}
.mini.obs{background:linear-gradient(180deg,#60a5fa,#1d4ed8)}
.mini.loading{opacity:.75;pointer-events:none}

.list-head label input {
  width: 18px;
  height: 18px;
}

/* radios no menu */
.menu label {
  display: flex;
  align-items: center;
  gap: 8px;         /* espa√ßo entre quadrado e texto */
  cursor: pointer;
  color: var(--ink);
}

.menu label input[type="radio"] {
  appearance: none;
  -webkit-appearance: none;
  width: 18px !important;     /* largura fixa */
  height: 18px !important;    /* altura igual -> quadrado */
  border: 2px solid var(--blue);
  border-radius: 3px;         /* levemente arredondado */
  background: #0b1528;
  cursor: pointer;
  flex: 0 0 18px;             /* impede de esticar no flex */
}

.menu label input[type="radio"]:checked {
  background: var(--blue);    /* quadrado todo preenchido */
}





.menu label input[type="radio"]:checked::after {
  content: "";
  position: absolute;
  top: 3px;
  left: 3px;
  width: 10px;
  height: 10px;
  background: var(--blue); /* quadradinho interno */
  border-radius: 2px;      /* opcional: arredondar canto do "check" */
}


.footer {
  position: fixed;
  right: 12px;
  bottom: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  align-items: flex-end;
  z-index: 15;
}
.bubble {
  background: var(--blue);
  color: #fff;
  border-radius: 8px;
  padding: 6px 10px;
  font-weight: 700;
  font-size: 13px;
  text-align: right;
  display: none;
  width: auto;
  box-shadow: 0 2px 6px rgba(0,0,0,.3);
}
.btn-massa {
  background: linear-gradient(180deg, var(--teal), #0796ad);
  color: #002027;
  border: 0;
  border-radius: 8px;
  padding: 6px 12px;
  font-weight: 700;
  font-size: 13px;
  cursor: pointer;
  display: none;
  width: auto;
  position: relative;
  overflow: hidden;
  box-shadow: 0 2px 6px rgba(0,0,0,.3);
}
.btn-massa.loading {
  opacity: .8;
  pointer-events: none;
}

/* Menu de empresas sempre acima de tudo */
.menu {
  position: absolute;
  top: 100%;
  right: 0;
  background: #0f172a;
  border: 1px solid var(--line);
  border-radius: 14px;
  padding: 14px;
  box-shadow: 0 10px 30px rgba(0,0,0,.4);
  display: none;
  z-index: 9999;   /* üîπ bem acima dos status cards */
  min-width: 220px;
}





.modal{position:fixed;inset:0;background:rgba(2,6,15,.65);display:none;align-items:center;justify-content:center;z-index:200}
.modal .box{background:#0f172a;border:1px solid var(--line);border-radius:16px;max-width:95%;width:500px;padding:16px}
.modal h3{margin:0 0 12px;font-size:18px}
.modal .close{float:right;border:1px solid var(--line);background:#0b1528;border-radius:8px;color:#fff;padding:6px 12px;cursor:pointer;font-size:14px}
textarea{width:100%;min-height:90px;border-radius:8px;border:1px solid #22314b;background:#0b1528;color:#fff;padding:10px;font-size:14px}
</style>
</head>
<body>
<header>
  <h1>CAP - Grupo DV</h1>

  <!-- üîπ Linha de filtros -->
  <div class="filtros-linha">
    <select id="filtroStatus">
      <option value="Pendente" selected>Pendentes</option>
      <option value="Aprovado">Aprovados</option>
      <option value="Negado">Negados</option>
      <option value="Todos">Todos</option>
    </select>

    <select id="filtroMeio">
      <option value="Todos" selected>Todos</option>
      <option value="Pix">Pix</option>
      <option value="Cart√£o">Cart√£o</option>
      <option value="Boleto">Boleto</option>
      <option value="Outros">Outros</option>
    </select>

    <input type="text" id="filtroPeriodo" placeholder="Per√≠odo" />

    <div style="position:relative;flex:1;z-index:9999">
      <button class="btn icon" id="btnEmpresas">
        <span id="empresaSelecionada">CAP VILLA</span> ‚ñº
      </button>
      <div id="menuEmpresas" class="menu"></div>
    </div>
  </div>

  <!-- üîπ Linha dos valores de status -->
  <div class="status-header">
    <div class="status-item aprovado">
      <span>Aprovado</span>
      <b id="valAprovado">R$ 0,00</b>
    </div>
    <div class="status-item pendente">
      <span>Pendente</span>
      <b id="valPendente">R$ 0,00</b>
    </div>
    <div class="status-item negado">
      <span>Negado</span>
      <b id="valNegado">R$ 0,00</b>
    </div>
  </div>
</header>


<div id="overlay"><div class="spinner"></div></div>

<div class="container">
  <div id="statusCards" class="status-cards"></div>
  <div class="mods-card">
    <div style="font-weight:800;margin-bottom:8px;font-size:16px">Modalidades</div>
    <div id="mods" class="mods"></div>
  </div>

 <div class="list-head">
  <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
    <input id="master" type="checkbox" />
    <b>Selecionar todos</b>
  </label>
  <div id="contagem" style="color:var(--muted);font-size:14px">0 itens</div>
</div>

  <div id="lista" class="lista"></div>
</div>

<div class="footer">
  <div id="bubble" class="bubble" style="display:none"></div>
  <button id="btnMassa" class="btn-massa" style="display:none"><span>Aprovar selecionados</span><div class="spinner-btn"></div></button>
</div>

<!-- modal observa√ß√£o -->
<div id="modalObs" class="modal">
  <div class="box">
    <button class="close" onclick="fecharObs()">Fechar</button>
    <h3>Observa√ß√£o</h3>
    <textarea id="textoObs" placeholder="Digite a observa√ß√£o..."></textarea>
    <button class="btn" style="margin-top:10px" onclick="salvarObs()"><span>Salvar</span><div class="spinner-btn"></div></button>
  </div>
</div>

<script>
const endpointTitulos="https://script.google.com/macros/s/AKfycbzUfUXj5b9QB6v02RhshJCFeIzDT_DwihSYDdtgctANVpqFZol6dDe4WXfuYu7b9CKB/exec";
const EMP_DEFAULT=["CAP VILLA"];
let TITULOS={},SELEC=[],obsContext={};

// üîπ NOVO: vari√°veis globais para armazenar o per√≠odo
let periodoInicio = null;
let periodoFim = null;


const $=id=>document.getElementById(id);
const BRL=n=>(isNaN(n)?0:n).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
function parseValor(v){
  if (v === null || v === undefined) return 0;

  // Se j√° for n√∫mero, retorna direto
  if (typeof v === "number") return v;

  // Se for string, faz a limpeza
  let str = v.trim();
  str = str.replace(/[^\d,.-]/g, "");  // remove R$, espa√ßos, etc
  str = str.replace(/\.(?=\d{3}(,|$))/g, ""); // remove pontos de milhar (somente os corretos)
  str = str.replace(",", ".");         // troca v√≠rgula por ponto decimal
  return parseFloat(str) || 0;
}

const iso = d => { const dt=new Date(d); dt.setMinutes(dt.getMinutes()-dt.getTimezoneOffset()); return dt.toISOString().slice(0,10); };
const ID=(emp,linha)=>`${emp.replace(/\s+/g,'_')}__${linha}`;

function setLoading(btn,on=true){if(on)btn.classList.add("loading");else btn.classList.remove("loading");}

function normalizeMeio(meio){
  meio = (meio||"Outros").toLowerCase();
  if(meio.includes("pix")) return "Pix";
  if(meio.includes("cart")) return "Cart√£o";
  if(meio.includes("bol")) return "Boleto";
  return "Outros";
}

function addHistLocal(id,texto){
  let hist=JSON.parse(localStorage.getItem("hist_"+id)||"[]");
  hist.push({data:new Date().toLocaleString("pt-BR"),texto});
  localStorage.setItem("hist_"+id,JSON.stringify(hist));
}
function getHistLocal(id){return JSON.parse(localStorage.getItem("hist_"+id)||"[]");}

function renderMods(){
  const mods=$("mods");mods.innerHTML="";
  const statusCards=$("statusCards");if(statusCards) statusCards.innerHTML="";

  let soma={Pix:0,Cart√£o:0,Boleto:0,Outros:0,Total:0};
  let somaStatus={Aprovado:0,Negado:0,Pendente:0};

  for(const emp of Object.keys(TITULOS)){
    (TITULOS[emp].__all||[]).forEach(t=>{
      const status=(t.status||"Pendente");
      const valor=parseValor(t.valor);
      const meio=normalizeMeio(t.meio_pagamento);
      soma.Total+=valor;
      soma[meio]+=valor;
      if(somaStatus[status]!==undefined) somaStatus[status]+=valor;
    });
  }

  // ‚úÖ Atualiza os valores do cabe√ßalho
  $("valAprovado").textContent = BRL(somaStatus.Aprovado);
  $("valPendente").textContent = BRL(somaStatus.Pendente);
  $("valNegado").textContent   = BRL(somaStatus.Negado);

  // üîπ Render modalidades (mant√©m o bloco existente)
  const card=(cls,label,val)=>`<div class="mod ${cls}"><span>${label}</span><b>${BRL(val)}</b></div>`;
  mods.innerHTML+=card("pix","Pix",soma.Pix);
  mods.innerHTML+=card("cartao","Cart√£o",soma["Cart√£o"]);
  mods.innerHTML+=card("boleto","Boleto",soma.Boleto);
  mods.innerHTML+=card("total","Total",soma.Total);
}


function renderLista(){
  const lista=$("lista");lista.innerHTML="";SELEC=[];$("master").checked=false;
  let totalItens=0;

  for(const emp of Object.keys(TITULOS)){
    // üîπ agora ordena do mais recente (maior vencimento) para o mais antigo
    const sorted = [...(TITULOS[emp].__filtered||[])]
      .sort((a,b)=> new Date(b.vencimento) - new Date(a.vencimento));

    sorted.forEach((t)=>{
      totalItens++;
      const valor=parseValor(t.valor);
      const id=ID(emp,t.linha);
      const st=(t.status || "Pendente");
      const obs=(t.observacao || "");
      const histColuna=(t.historico || "");
      const histLocal=getHistLocal(id);

      const card=document.createElement("div");
      card.className="titulo";card.dataset.id=id;card.dataset.emp=emp;card.dataset.linha=t.linha;card.dataset.valor=valor;
      card.innerHTML=`
        <div class="ck"><input type="checkbox" onchange="toggleSel(this)" /></div>
        <div class="info">
          <div class="row"><b>${t.fornecedor}</b> ‚Ä¢ ${emp}</div>
          <div class="row">Venc: <b>${iso(t.vencimento).split("-").reverse().join("/")}</b> ‚Ä¢ Meio: <b>${t.meio_pagamento||"Outros"}</b></div>
          <div class="row">Valor: <b>${BRL(valor)}</b></div>
          ${obs ? `<div class="row obs" style="color:#60a5fa">Obs (planilha): ${obs}</div>` : ""}
          ${histColuna ? `<div class="row hist">Hist√≥rico F360: ${histColuna}</div>` : ""}
        </div>
        <span class="pill" data-status>${st}</span>
        <div class="actions">
          <button class="mini obs" onclick="abrirObs('${id}','${emp}',${t.linha},\`${obs}\`,'${t.fornecedor}')"><span>‚úèÔ∏è Obs</span><div class="spinner-btn"></div></button>
          <button class="mini negar" onclick="acaoStatus(this,'Negado')"><span>‚úó Negar</span><div class="spinner-btn"></div></button>
          <button class="mini aprovar" onclick="acaoStatus(this,'Aprovado')"><span>‚úì Aprovar</span><div class="spinner-btn"></div></button>
        </div>`;

      card.addEventListener("dblclick", ()=>{
        const chk = card.querySelector(".ck input");
        chk.checked = !chk.checked;
        toggleSel(chk);
      });

      setPill(card.querySelector("[data-status]"),st);
      lista.appendChild(card);
    });
  }
  $("contagem").textContent=`${totalItens} ${totalItens===1?"item":"itens"}`;
  renderMods();
  atualizarBubble(); // üîπ garante que o bubble sempre reflete o total aprovado
}


function setPill(el,status){
  el.className="pill";
  if(status==="Aprovado"){el.classList.add("ok");el.textContent="Aprovado"}
  else if(status==="Negado"){el.classList.add("warn");el.textContent="Negado"}
  else el.textContent=status;
}

function toggleSel(chk){
  const card=chk.closest(".titulo");
  const id=card.dataset.id,emp=card.dataset.emp,linha=Number(card.dataset.linha),valor=Number(card.dataset.valor)||0;
  if(chk.checked) SELEC.push({id,emp,linha,valor});
  else SELEC=SELEC.filter(x=>x.id!==id);
  $("btnMassa").style.display = SELEC.length ? "block" : "none";
}


// üîπ Sele√ß√£o em massa
$("master").addEventListener("change",function(){
  const chks=document.querySelectorAll(".titulo .ck input");
  chks.forEach(chk=>{
    chk.checked=this.checked;
    toggleSel(chk);
  });
});

// ‚úÖ a√ß√£o individual (n√£o bloqueia nem trava)
async function acaoStatus(btn, novo) {
  const card = btn.closest(".titulo");
  const emp = card.dataset.emp,
        linha = card.dataset.linha,
        id = card.dataset.id;

  // muda status visual e remove da tela antes da chamada
  setPill(card.querySelector("[data-status]"), novo);
  addHistLocal(id, "Status alterado para " + novo);
  card.style.opacity = "0.6";
  card.style.transition = "opacity 0.3s ease";

  // remove da tela logo ap√≥s clique
  setTimeout(() => card.remove(), 300);

  // faz atualiza√ß√£o em segundo plano
  (async () => {
    try {
      await fetch(
        `${endpointTitulos}?action=atualizar&empresa=${encodeURIComponent(emp)}&linha=${linha}&status=${encodeURIComponent(novo)}`
      );
    } catch (e) {
      console.error("Erro ao atualizar status:", e);
    }
  })();

  atualizarBubble();
}

// ‚úÖ atualiza√ß√£o em massa com execu√ß√£o garantida
async function atualizarStatusMassa(novo = "Aprovado") {
  if (SELEC.length === 0) return;
  const btn = $("btnMassa");
  setLoading(btn, true);

  // Executa todas as atualiza√ß√µes em paralelo
  await Promise.all(SELEC.map(async (s) => {
    const card = document.querySelector(`.titulo[data-id="${s.id}"]`);
    if (!card) return;
    setPill(card.querySelector("[data-status]"), novo);
    addHistLocal(s.id, "Status alterado para " + novo);
    card.style.opacity = "0.6";
    card.style.transition = "opacity 0.3s ease";
    setTimeout(() => card.remove(), 300);

    try {
      await fetch(`${endpointTitulos}?action=atualizar&empresa=${encodeURIComponent(s.emp)}&linha=${s.linha}&status=${encodeURIComponent(novo)}`);
    } catch (e) {
      console.error("Erro ao aprovar massa:", e);
    }
  }));

  // Limpa sele√ß√£o e atualiza interface
  SELEC = [];
  $("master").checked = false;
  $("bubble").style.display = "none";
  $("btnMassa").style.display = "none";
  setLoading(btn, false);
  atualizarBubble();
}

// ‚úÖ Garante que o bot√£o funciona mesmo ap√≥s renderiza√ß√µes
document.addEventListener("DOMContentLoaded", () => {
  $("btnMassa").addEventListener("click", () => atualizarStatusMassa("Aprovado"));
});




  function atualizarBubble(){
  let totalAprovado = 0;
  document.querySelectorAll(".titulo").forEach(card=>{
    const status = card.querySelector("[data-status]").textContent;
    const valor = Number(card.dataset.valor) || 0;
    if(status === "Aprovado"){
      totalAprovado += valor;
    }
  });

  if(totalAprovado > 0){
    $("bubble").style.display="block";
    $("bubble").textContent="Total aprovado: " + BRL(totalAprovado);
  } else {
    $("bubble").style.display="none";
  }
}

function abrirObs(id,emp,linha,txt,fornecedor){
  obsContext={id,emp,linha};
  $("textoObs").value=txt||"";
  $("modalObs").style.display="flex";
  $("modalObs").querySelector("h3").textContent = "Observa√ß√£o - " + fornecedor;
}

function fecharObs(){$("modalObs").style.display="none"}
async function salvarObs(){
  const {id,emp,linha}=obsContext;
  const texto=$("textoObs").value.trim();
  if(!texto)return;
  const btn=$("modalObs").querySelector(".btn");
  setLoading(btn,true);
  addHistLocal(id,"Obs pendente: "+texto);
  renderLista();
  try{
    const resp = await fetch(`${endpointTitulos}?action=atualizarObservacao&empresa=${encodeURIComponent(emp)}&linha=${linha}&texto=${encodeURIComponent(texto)}`);
    if(resp.ok){
      localStorage.removeItem("hist_"+id);
      const card=document.querySelector(`.titulo[data-id="${id}"]`);
      if(card){
        const info=card.querySelector(".info");
        info.querySelectorAll(".row.obs").forEach(e=>e.remove());
        const div=document.createElement("div");
        div.className="row obs";div.style.color="#60a5fa";
        div.textContent="Obs (planilha): "+texto;
        info.appendChild(div);
      }
    }
  }catch(e){console.error(e)}
  setLoading(btn,false);
  fecharObs();
}

// üîπ Salva no storage local
function salvarCache(emp, data){
  localStorage.setItem("cache_"+emp, JSON.stringify({
    ts: Date.now(),
    data
  }));
}

// üîπ L√™ do storage local
function lerCache(emp){
  const raw = localStorage.getItem("cache_"+emp);
  if(!raw) return null;
  try {
    return JSON.parse(raw).data || null;
  } catch(e){ return null; }
}

// üîπ Busca direto da planilha e atualiza cache
async function fetchEmpresa(emp){
  try{
    const r = await fetch(`${endpointTitulos}?action=listar&empresa=${encodeURIComponent(emp)}`);
    const d = await r.json();
    const data = d.titulos || d;
    salvarCache(emp,data);
    return data;
  }catch(e){
    console.error("Erro ao buscar", emp, e);
    return lerCache(emp) || [];
  }
}

async function loadTitulos(empresas,inicio,fim,filtroStatus,filtroMeio){
  TITULOS={}; 
  

  // Aguarda todas as empresas carregarem
  await Promise.all(empresas.map(async emp=>{
    let data = lerCache(emp) || [];
    processarEmpresa(emp,data,inicio,fim,filtroStatus,filtroMeio);

    try {
      const dataNova = await fetchEmpresa(emp);
      processarEmpresa(emp,dataNova,inicio,fim,filtroStatus,filtroMeio);
    } catch(e){
      console.error("Erro ao buscar",emp,e);
    }
  }));

  renderLista();
  $("overlay").style.display="none"; // üîπ agora s√≥ esconde quando terminar tudo
}


// üîπ Aplica filtros e salva no objeto global
function processarEmpresa(emp,data,inicio,fim,filtroStatus,filtroMeio){
  const all=data.filter(t=>{
    const d=iso(t.vencimento);
    return (!inicio||d>=inicio)&&(!fim||d<=fim);
  });
  const filtered=all.filter(t=>{
    let st=(t.status||"Pendente");
    const meio=normalizeMeio(t.meio_pagamento);
    const statusOk=filtroStatus==="Todos"?true:(st===filtroStatus);
    const meioOk=filtroMeio==="Todos"?true:(meio===filtroMeio);
    return statusOk&&meioOk;
  });
  TITULOS[emp]={__all:all,__filtered:filtered};
}

// üîπ Agora refresh s√≥ carrega a empresa selecionada e atualiza as outras em background
async function refresh(){
  const filtro=$("filtroStatus").value;
  const filtroMeio=$("filtroMeio").value;
  const empresa=document.querySelector("#menuEmpresas input:checked").value;

  const ini = periodoInicio || iso(new Date());
  const fim = periodoFim   || iso(new Date());

  await loadTitulos([empresa],ini,fim,filtro,filtroMeio);
  $("empresaSelecionada").textContent=empresa;
  renderLista();

  // Em segundo plano atualiza cache das demais
  EMP_DEFAULT.filter(e=>e!==empresa).forEach(e=>fetchEmpresa(e));
}


(function boot(){
  const hoje = new Date(); // objeto Date do dia atual
  flatpickr("#filtroPeriodo", {
    mode: "range",
    dateFormat: "d/m/Y", // formato brasileiro
    locale: "pt",
    defaultDate: [hoje, hoje], // agora pega o dia atual certo
 onClose: sel=>{
  if(sel.length===2){
    periodoInicio = iso(sel[0]); 
    periodoFim = iso(sel[1]);
    $("overlay").style.display="flex";   // ‚úÖ mostra overlay s√≥ aqui
    refresh();
  }
}


  });

  const M=$("menuEmpresas");
EMP_DEFAULT.forEach((emp,i)=>{
  const lbl=document.createElement("label");
  lbl.style.display = "flex";
  lbl.style.alignItems = "center";
  lbl.style.gap = "8px"; // espa√ßo entre bolinha e texto
  lbl.innerHTML = `<input type="radio" name="empresaSel" value="${emp}" ${i===0?"checked":""}><span>${emp}</span>`;
lbl.querySelector("input").onchange = ()=>{
  $("empresaSelecionada").textContent = emp; // ‚úÖ troca o nome exibido
  $("overlay").style.display="flex";
  refresh();                                 // ‚úÖ carrega s√≥ a empresa atual
  M.style.display="none";
};
  M.appendChild(lbl);
});


  $("btnEmpresas").onclick=(e)=>{e.stopPropagation();M.style.display=M.style.display==="block"?"none":"block";};
  document.addEventListener("click",(e)=>{if(!M.contains(e.target)&&e.target.id!=="btnEmpresas"){M.style.display="none";}});
 $("filtroStatus").onchange=()=>refresh();
$("filtroMeio").onchange=()=>refresh();
refresh();
})();
// üîÑ Atualiza√ß√£o autom√°tica a cada 15 segundos
setInterval(() => {
  refresh();
}, 15000);

</script>
</body>
</html>
